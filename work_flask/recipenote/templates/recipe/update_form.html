{% extends "base.html" %}

<!-- {#{% block content %}
    <h1>レシピノートを編集</h1>

    {% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="alert alert-warning">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
    {% from "_formhelpers.html" import render_field %}
    <form method="post" action="{{ url_for('recipe.update', recipe_id=edit_id) }}" novalidate>
        {{ form.hidden_tag() }}
        {{ render_field(form.title,class_="w-50") }}
        
        //{% if form.image_path != "" %}
        //    <figure><img src="{{url_for('static', filename=form.image_path.data)}}" alt="レシピ画像"></figure>
        //{% endif %}
        
        
        {% if form.image_path.data %}
            <div class="text-center w-75 mx-auto">
                {% set parts = form.image_path.data.split('/') %}
                <img src="{{ url_for('recipe.user_image', user_id=parts[1], filename=parts[2]) }}" alt="レシピ画像">
            </div>
        {% endif %}

        

        
            
            <div id="foods_id">
                
                <div class="row">
                    <div class="col-7">材料</div>
                    <div class="col-3">分量</div>
                </div>
                {% for food in foods_data %}
                    <div class="foods_add_class row" id="food{{ loop.index }}">
                        <div class="col-7 d-flex align-items-center">
                            <label for="foods{{loop.index}}" id="foods_label{{loop.index}}" class="me-2">{{loop.index}}.</label>
                            <input type="text" value="{{ food.foods }}" name="foods[]" id="foods{{loop.index}}" class="w-100">
                        </div>
                        <div class="col-3">
                            <input type="text" value="{{food.quantity}}" name="quantity[]" id="quantity_id{{loop.index}}" class="w-100">
                        </div>

                        {% if loop.index != 1 %}
                            <div class="col-2">
                                <button id="delete{{loop.index}}" type="button" class="delete_class_foods">削除</button>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button id="add_foods" type="button">材料を追加</button>
            <div id="process">
                <div>作り方</div>
                {% for process in process_data %}
                    <div class="process_add_class align-items-end row" id="process{{loop.index}}">
                        <div class="col-10">
                            <label id="process_label{{loop.index}}" class="me-2">{{loop.index}}.</label>
                            <textarea name="process_text[]" id="process_text{{ loop.index }}" class="w-100">{{ process.process_content }}</textarea>
                        </div>
                    
                        {% if loop.index != 1 %}
                            <div class="col-2">
                                <button id="process_delete{{loop.index}}" type="button" class="delete_class_process">削除</button>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button id="add_process" type="button">作り方を追加</button>

        
        {{ render_field(form.content, rows=5, class_="w-100") }}

        
        {{ form.submit }}
    </form>

    <a href="{{ url_for('recipe.index') }}">戻る</a> #}-->

{% block content %}
<h1 class="mb-3">レシピノートを編集</h1>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="alert alert-warning">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}



{% from "_formhelpers.html" import render_field %}
<form method="post" action="{{ url_for('recipe.update', recipe_id=edit_id) }}" enctype="multipart/form-data" novalidate>
    
        
    {{ form.hidden_tag() }}
    <!-- タイトル入力 -->
    <h2 class="col-12 col-md-6">{{ form.title(class_="w-100 my-2 fs-5 py-1 px-3") }}</h2>
    {% for error in form.title.errors %}
        <div class="form-text text-danger small fs-5">{{ error }}</div>
    {% endfor %}

    <div class="my-3">
        <h2><label for="file">画像を変更</label></h2>
        <input type="file" name="file" id="file" class="form-control">
        

        

    </div>



    {# 既存画像がある場合のプレビュー #}
    
    <div id="preview" class="{{ 'd-block' if image_path else 'd-none' }}">
        <small class="form-text text-muted" id="sm_font">
            ※現在の画像はそのまま使われます。変更したい場合のみ画像を選択してください。
        </small>
    
        

        <div class="text-center w-75 m-auto" id="img_big_data">
            {% if image_path%}
                <img id="img_data" src="{{ url_for('recipe.user_image', user_id=current_user.id, filename=image_path.split('/')[-1]) }}" class="my-3 w-100" alt="レシピ画像">
            {% endif%}
            <p>{{imgage_path}}</p>
        </div>
        

        <div class="d-flex justify-content-start">
            <input type="hidden" name="delete_image" id="delete_image_flag" value="0">
            <button id="delete_file" class="btn btn-danger col-xl-2" type="button">ファイルの削除</button>
        </div>
    </div>
    



    

    

    <div id="foods_id" class="mt-5">
        <div class="row">
            <div class="col-xl-7 col-md-8 d-none d-md-block"><h2>材料</h2></div>
            <div class="col-xl-4 col-md-4 d-none d-md-block"><h2>分量</h2></div>
        </div>
        {% for food in foods_data %}
            <div class="foods_add_class row d-flex align-items-end my-4" id="food{{ loop.index }}">
                <div class="col-xl-7 col-md-8 d-flex justify-content-end">
                    <label for="foods{{loop.index}}" id="foods_label{{loop.index}}" class="col-md-1">{{loop.index}}.</label>
                    <div class="d-block d-md-none col-2">材料</div>
                    <div class="col-10 col-md-11">
                        <input type="text" value="{{ food.foods if food.foods is defined else food['foods'] }}" name="foods[]" id="foods{{loop.index}}" class="w-100 py-1 px-3 col-12">
                    </div>
                </div>
                <div class="col-xl-4 col-md-4 col-12 d-flex justify-content-end my-2 my-md-0">
                    <div class="d-block d-md-none col-2">分量</div>
                    <div class="col-10 col-md-12"><input type="text" value="{{ food.quantity if food.quantity is defined else food['quantity'] }}" name="quantity[]" id="quantity_id{{loop.index}}" class="w-100 py-1 px-3"></div>
                </div>

                {% if loop.index != 1 %}
                    <div class="my-3 my-xl-0 col-xl-1 col-md-12 d-flex justify-content-end ">
                        <button id="delete{{loop.index}}" type="button" class="btn btn-danger delete_class_foods">削除</button>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <button id="add_foods" type="button" class="btn btn-secondary">材料を追加</button>

    <div id="process">
        <h2 class="mt-5">作り方</h2>
        {% for process in process_data %}
            <div class="process_add_class align-items-end row d-flex my-1" id="process{{loop.index}}">
                    <div class="col-xl-11 col-md-12">
                        <label id="process_label{{loop.index}}" class="w-100 py-1 px-3">{{loop.index}}.</label>
                        <div class="d-flex align-items-end">
                            <textarea name="process_text[]" id="process_text{{ loop.index }}" class="w-100 py-1 px-3">{{ process.process_content if process.process_content is defined else process['process_content'] }}</textarea>
                        </div>
                            
                        
                    </div>
                    {% if loop.index != 1 %}
                        <div class="my-1 my-xl-0 col-xl-1 col-md-12 d-flex justify-content-end ">
                            <button id="process_delete{{loop.index}}" type="button" class="btn btn-danger delete_class_process my-3">削除</button>
                        </div>
                    {% endif %}
                
            </div>
        {% endfor %}
    </div>
    <button id="add_process" type="button" class="btn btn-secondary mt-4">作り方を追加</button>

    <h2 class="mt-5">{{ render_field(form.content, rows=5, class_="w-100 fs-6 py-1 px-3") }}</h2>
    <div class="d-flex justify-content-around align-items-center my-5">
        <div><a href="{{ url_for('recipe.index') }}" class="btn-lg btn btn-secondary">戻る</a></div>
        <div>{{ form.submit(class_="btn btn-primary btn-lg px-5 py-3 fs-5") }}</div>
    </div>
    
    
</form>






    <script>
        //以下、create_form.htmlのscriptをもとに書き換えたもの

        
        // window.onload = function() {
        //         let preview = document.getElementById("preview");
        //         let img_data = document.getElementById("img_data");
                
        //         if (!img_data){
                    
        //             preview.className = "d-none"
        //         }else{
        //             preview.className = "d-block"
        //         }
        // }

        
        document.getElementById("delete_file").addEventListener("click", function () {

            let img_data = document.getElementById("img_data");
            img_data.src = "";

            document.getElementById("preview").style.display = "none"; 
            let sm_font = document.getElementById("sm_font");
            sm_font.style.display = "none"

            let fileInput = document.getElementById("file");
            let preview = document.getElementById("preview");
            let delete_file = document.getElementById("delete_file");
            document.getElementById("delete_image_flag").value = "1";

            fileInput.value = ""; // ファイル選択解除
            preview.src = "";
            preview.style.display = "none";
            delete_file.style.display = "none";
            img_data.style.display = "none"
        });

            // fileをアップロードするやつ
        document.getElementById("file").addEventListener("change", function (event) {
            let old_img = document.getElementById("img_data")
            if(old_img){

                
                const file = event.target.files[0];
                const preview = document.getElementById("preview");
                let img_data = document.getElementById("img_data");
                var delete_file = document.getElementById("delete_file")
                let sm_font = document.getElementById("sm_font");
                sm_font.style.display = "block"

                if (file && file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        img_data.src = e.target.result;
                        preview.style.display = "block";
                        delete_file.style.display = "block";
                        img_data.style.display = "block";
                        document.getElementById("delete_image_flag").value = "0";
                        
                    }
                    reader.readAsDataURL(file);
                } else {
                    preview.src = "#";
                    preview.style.display = "none";
                    delete_file.style.display = "none"
                }
            }else{
                let img_big_data = document.getElementById("img_big_data");
                let img = document.createElement("img")
                let preview = document.getElementById("preview")
                img.id = "img_data"
                preview.className = "";
                img_big_data.append(img)
                // if (file && file.type.startsWith("image/")) {
                // const reader = new FileReader();
                // reader.onload = function (e) {
                //     img.src = e.target.result;
                // }
            
                        

                // } 
                
                 const file = this.files[0]; // 最初のファイルだけ取得
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        
                        img.src = e.target.result; // base64のsrc
                        img.className = "my-3 w-100"
                        
                    };
                    reader.readAsDataURL(file); // <== srcとして読み込むここがポイント
        }}});

        


        var count_food = 1;
        var delete_btn;
        var delete_count
        var process_count = 1;
        

        function foods_list(){
            count_food = document.getElementsByClassName("foods_add_class").length
            return count_food
        }

        function process_list(){
            process_count = document.getElementsByClassName("process_add_class").length
            return process_count
        }

        window.onload = function(){
            //preview = document.getElementById("preview")
            //preview.style.display = "none"
            //delete_file = document.getElementById("delete_file")
            //delete_file.style.display = "none"

            const num = document.getElementsByClassName("delete_class_foods").length + 1
            for(let b = 2; b <= num; b ++){
            document.getElementById("delete" + b).addEventListener("click", function() {
                
                delete_count = parseInt(event.target.id.replace("delete",""));
                div_name = document.getElementById("food" + delete_count)
                a = delete_count
                
                div_name.remove()
                let number = document.getElementsByClassName("delete_class_foods").length
                for(let a = delete_count; a<= number + 1; a++){
                    
                    let big_num = parseInt(a) + 1;
                    let replace_label = document.getElementById("foods_label" + big_num);

                    replace_label.innerHTML = a + ".";
                    replace_label.htmlFor = "foods" + a;
                    replace_label.id = "foods_label" + a;
                    let replace_div = document.getElementById("food" + big_num)
                    replace_div.id = "food" + a;

                    let replace_input_food = document.getElementById("foods" + big_num);
                    replace_input_food.id = "foods" + a;
                    replace_input_food.name = "foods";

                    let replace_quantity = document.getElementById("quantity_id" + big_num);
                    replace_quantity.id = "quantity_id" + a;

                    let replace_btn = document.getElementById("delete" + big_num)
                    replace_btn.id = "delete" + a;
                    delete_btn.type = "button";
                    let delete_btn_div = document.createElement("div")
                    delete_btn_div.className = "col-2"
                    
                }
                count_food = count_food - 1;
                
            
                
            });
        }

            const num2 = document.getElementsByClassName("delete_class_process").length + 1
            if(num2 => 1){

            
            for(let a = 2; a < num2 + 1; a ++){
            document.getElementById("process_delete" + a).addEventListener("click", event => {
                
                let delete_process_count = parseInt(event.target.id.replace("process_delete",""));
                
                let div_name = document.getElementById("process" + delete_process_count)
                div_name.remove()
                let number = document.getElementsByClassName("delete_class_process").length
                for(let a = delete_process_count; a <= number + 1; a ++ ){
                    
                    let big_num = parseInt(a) + 1;
                    let small_num = parseInt(a) - 1;

                    let div_name = document.getElementById("process" + big_num);
                    if (!div_name){
                        continue
                    }
                    div_name.id = "process" + a;

                    let textarea_id = document.getElementById("process_text" + big_num);
                    textarea_id.id = "process_text" + a;

                    let delete_btn = document.getElementById("process_delete" + big_num);
                    delete_btn.id = "process_delete" + a;
                    delete_btn.innerHTML = "削除"
                    delete_btn.className ="btn btn-danger"


                    let replace_label = document.getElementById("process_label" + big_num);
                    replace_label.id = "process_label" + a; 
                    replace_label.textContent  = a + ".";
                    replace_label.htmlFor = "process_text" + a;

                    
                }
            

                process_count = process_count - 1;

            });
        }
        }
    }

    
        document.getElementById("add_foods").addEventListener("click", function() {
            count_food = foods_list()
            //alert('ボタンがクリックされました！');
            count_food = count_food + 1;
            var div = document.createElement('div');
            div.className = "foods_add_class row align-items-end d-flex my-4";
            div.id = "food" + count_food;

            
            let foodes_label = document.createElement("label");
            foodes_label.setAttribute('for', "foods" + count_food);
            foodes_label.id = "foods_label" + count_food; 
            foodes_label.textContent  = "材料" + count_food;
            foodes_label.className = "col-md-1"
            foodes_label.textContent  = count_food + ".";

            let foods_new = document.createElement("input");
            foods_new.type = "text"
            foods_new.name = "foods[]";
            foods_new.className = "w-100 py-1 px-3"
            foods_new.id = "foods" + count_food;
            var bigFoodDiv = document.getElementById("foods_id");
            let foods_list_div = document.createElement("div")
            foods_list_div.className = "col-xl-7 col-md-8 d-flex justify-content-end "
            let foodes_h2 = document.createElement("div")
            foodes_h2.className = "d-block d-md-none col-2"
            foodes_h2.innerHTML = "材料"
            let div_2 = document.createElement("div")
            div_2.className = "col-10 col-md-11"
            div_2.append(foods_new)
            foods_list_div.append(foodes_label);
            foods_list_div.append(foodes_h2)
            foods_list_div.append(div_2);
            div.append(foods_list_div)
            
            let quantity_new = document.createElement('input');
            quantity_new.name = "quantity[]";
            quantity_new.type = "text"
            quantity_new.id = "quantity_id" + count_food
            quantity_new.className = "w-100 py-1 px-3"
            let div_quantity = document.createElement("div")
            div_quantity.className = "col-xl-4 col-md-4 col-12 d-flex justify-content-end my-2 my-md-0"

            let div_quantity_h2 = document.createElement("div")
            div_quantity_h2.className = "d-block d-md-none col-2"
            div_quantity_h2.innerHTML = "分量"

            div_quantity.append(div_quantity_h2);
            div_quantity.append(quantity_new);
            div.append(div_quantity)
            
            let delete_btn = document.createElement("button");
            delete_btn.innerHTML = "削除";
            delete_btn.id = "delete" + count_food;
            delete_btn.type = "button";
            delete_btn.className = "btn btn-danger delete_class_foods"

            let delete_btn_div = document.createElement("div")
            delete_btn_div.className = "my-3 my-xl-0 col-xl-1 col-md-12 d-flex justify-content-end "
            delete_btn_div.append(delete_btn)
            
            div.append(delete_btn_div);
            bigFoodDiv.append(div);

                
            delete_btn.addEventListener("click", event => {
                delete_count = parseInt(event.target.id.replace("delete",""));
                div_name = document.getElementById("food" + delete_count)

                div_name.remove()
                for(let a = delete_count; a <= count_food; a ++ ){
                    let big_num = parseInt(a) + 1;
                    let small_num = parseInt(a) - 1;
                    let replace_label = document.getElementById("foods_label" + big_num);
                    if (!replace_label){
                        continue
                    }
                    //alert(replace_label);
                    replace_label.innerHTML = a + ".";
                    replace_label.htmlFor = "foods" + a;
                    replace_label.id = "foods_label" + a;
                    //alert("wa");
                    
                    let replace_div = document.getElementById("food" + big_num)
                    replace_div.id = "food" + a;

                    let replace_input_food = document.getElementById("foods" + big_num);
                    replace_input_food.id = "foods" + a;
                    replace_input_food.name = "foods";

                    let replace_quantity = document.getElementById("quantity_id" + big_num);
                    replace_quantity.id = "quantity_id" + a;

                    let replace_btn = document.getElementById("delete" + big_num)
                    delete_btn.innerHTML = "削除";
                    delete_btn.id = "delete" + a;
                    delete_btn.className = "btn btn-danger"

                    
                }

                count_food = count_food - 1;
            
            });

            
        
            
            
        });




        document.getElementById("add_process").addEventListener("click", function() {
            process_count = process_list() + 1;

            var div_process = document.createElement('div');
            div_process.className = "process_add_class row align-items-end d-flex my-1";
            div_process.id = "process" + process_count;


            var div_process_small = document.createElement("div");
            div_process_small.className = "col-xl-11 col-md-12"


            let process_label = document.createElement("label");
            process_label.setAttribute('for', "process_text" + process_count);
            process_label.id = "process_label" + process_count; 
            process_label.textContent  = process_count + ".";
            process_label.className = "w-100 py-1 px-3"

            var bigProcess = document.getElementById("process");

            let add_process_list = document.createElement("textarea");
            add_process_list.id = "process_text" + process_count;
            add_process_list.className = "w-100 py-1 px-3"
            add_process_list.name = "process_text[]";

            var div_delete_process_btn = document.createElement("div");
            div_delete_process_btn.className = "my-3 my-xl-0 col-xl-1 col-12 d-flex justify-content-end "

            let delete_process_btn = document.createElement("button");
            delete_process_btn.innerHTML = "削除";
            delete_process_btn.id = "process_delete" + process_count;
            delete_process_btn.type = "button";
            delete_process_btn.className = "btn btn-danger delete_class_process"
            delete_process_btn.addEventListener("click", event => {
                //alert(event.target.id)
                let delete_process_count = parseInt(event.target.id.replace("process_delete",""));
                
                let div_name = document.getElementById("process" + delete_process_count)
                //alert("process_div" + delete_process_count)
                div_name.remove()
                for(let a = delete_process_count; a <= process_count; a ++ ){
                    //alert(parseInt(a) + 1);
                    let big_num = parseInt(a) + 1;
                    let small_num = parseInt(a) - 1;

                    let div_name = document.getElementById("process" + big_num);
                    if (!div_name){
                        continue
                    }
                    div_name.id = "process" + a;

                    let textarea_id = document.getElementById("process_text" + big_num);
                    textarea_id.id = "process_text" + a;

                    let delete_btn = document.getElementById("process_delete" + big_num);
                    delete_btn.id = "process_delete" + a;
                    delete_btn.innerHTML = "削除"
                    delete_btn.className = "btn btn-danger"

                    let replace_label = document.getElementById("process_label" + big_num);
                    replace_label.id = "process_label" + a; 
                    replace_label.textContent  = a + ".";
                    replace_label.htmlFor = "process_text" + a;

                    
                }

                process_count = process_count - 1;
            });

            div_process_small.append(process_label)
            div_process_small.append(add_process_list);
            div_process.append(div_process_small)
            div_delete_process_btn.append(delete_process_btn)
            div_process.append(div_delete_process_btn);
            
            bigProcess.append(div_process);

        });
        

    </script>
{% endblock %}
